# Use Amazon Linux 2023 ARM base image
FROM amazonlinux:2023

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive \
    VLLM_VERSION=0.3.3

# Install system dependencies
RUN dnf update -y && dnf groupinstall -y "Development Tools" && \
    dnf install -y \
    python3.11 \
    python3.11-devel \
    python3.11-pip \
    git \
    cmake \
    wget \
    gcc-c++ && \
    dnf clean all

# Create app user
RUN useradd -m -s /bin/bash app && \
    mkdir -p /app/models /app/data && \
    chown -R app:app /app

# Switch to app user
USER app

# Set working directory
WORKDIR /app

# Upgrade pip and install Python dependencies
COPY --chown=app:app requirements.txt /app/
RUN python3.11 -m pip install --no-cache-dir -U pip setuptools wheel && \
    python3.11 -m pip install --no-cache-dir -r requirements.txt

# Install vLLM from source for ARM support
RUN git clone https://github.com/vllm-project/vllm.git /tmp/vllm && \
    cd /tmp/vllm && \
    python3.11 -m pip install -e .

# Copy application code
COPY --chown=app:app . /app/

# Set default command
CMD ["python3.11", "-m", "scripts.setup_vllm"] 